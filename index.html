<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IDID^^</title>

  <style>
    :root {
      --b:#e6e6e6; --t:#111; --m:#666; --bg:#fafafa;
      --shadow: 0 1px 0 rgba(0,0,0,0.03);
    }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin: 18px; background: var(--bg); color: var(--t);
    }
    .wrap { max-width: 980px; margin: 0 auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .card {
      background:#fff; border:1px solid var(--b); border-radius:16px;
      padding:14px; margin-top:12px; box-shadow: var(--shadow);
    }
    .title { font-weight:900; font-size:22px; letter-spacing:0.2px; }
    .muted { color: var(--m); font-size:12px; }
    .pill {
      display:inline-block; padding:4px 10px; border-radius:999px;
      background:#f2f2f2; font-size:12px;
    }
    .sep { height:1px; background: var(--b); margin: 10px 0; }

    input, textarea { font-size:14px; }
    input[type="text"], input[type="password"]{
      padding:10px; border-radius:12px; border:1px solid var(--b);
      outline:none; width: 240px; box-sizing:border-box;
    }
    input[type="date"]{
      padding:10px; border-radius:12px; border:1px solid var(--b);
      outline:none;
    }
    textarea{
      width:100%; min-height: 280px;
      padding:12px; border-radius:14px; border:1px solid var(--b);
      box-sizing:border-box; outline:none;
    }
    button{
      padding:10px 12px; border-radius:12px;
      border:1px solid #bbb; background:#fff; cursor:pointer;
      white-space:nowrap;
    }
    button:hover{ background:#f6f6f6; }
    .ok{ border-color:#b7e3c5; }
    .ok:hover{ background:#f2fff6; }
    .danger{ border-color:#f0b1b1; }
    .danger:hover{ background:#fff3f3; }

    .hidden{ display:none !important; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 760px){
      .grid2{ grid-template-columns:1fr; }
      input[type="text"], input[type="password"]{ width:100%; }
    }
    .summaryBox{
      font-size:14px; line-height:1.45; white-space:pre-wrap;
    }

    /* Settings modal */
    .overlay{
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      display:flex; align-items:center; justify-content:center;
      padding: 16px; z-index: 9999;
    }
    .modal{
      width: min(760px, 100%);
      background:#fff; border:1px solid var(--b);
      border-radius:18px; padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.18);
    }
    .modalHeader{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .modalTitle{ font-weight:900; font-size:16px; }
    .modalClose{
      border-radius: 999px;
      width: 38px; height: 38px;
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
    }

    .footer{
      margin-top: 18px;
      text-align:center;
      color: var(--m);
      font-size: 12px;
      padding: 8px 0 2px;
    }
    .smallBtnRow button { padding:8px 10px; }
    .warnBox{
      border:1px solid #f0d2a1;
      background:#fff7ea;
      border-radius:14px;
      padding:10px;
      margin-top:10px;
      color:#6b4a00;
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="row">
    <div class="title">IDID^^</div>
    <span id="status" class="pill">Ready</span>
  </div>

  <!-- AUTH SCREEN -->
  <div id="authScreen" class="card">
    <div class="muted">Security Check</div>
    <div style="font-weight:800; font-size:16px; margin-top:6px;">ID + PIN ì…ë ¥</div>

    <div class="sep"></div>

    <div class="grid2">
      <div>
        <div class="muted">ID</div>
        <input id="idInput" type="text" placeholder="ì˜ˆ: admin" autocomplete="username" />
      </div>
      <div>
        <div class="muted">PIN (4~8ìë¦¬ ìˆ«ì)</div>
        <input id="pinInput" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="ì˜ˆ: 1234" autocomplete="current-password" />
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <button id="btnLogin" class="ok">ë¡œê·¸ì¸</button>
      <span class="muted">ì´ˆê¸°ê°’: ID=admin / PIN=1234</span>
    </div>

    <div id="authError" class="muted" style="margin-top:10px; color:#b00020;"></div>
  </div>

  <!-- APP SCREEN -->
  <div id="appScreen" class="hidden">

    <div class="card">
      <div class="row">
        <div>
          <div class="muted">ë‚ ì§œ ì„ íƒ (ë‹¬ë ¥ í´ë¦­)</div>
          <input id="datePicker" type="date" />
        </div>

        <div>
          <div class="muted">ì„ íƒëœ ë‚ ì§œ</div>
          <div id="selectedDateLabel" style="font-weight:900;">-</div>
        </div>

        <div style="margin-left:auto" class="row">
          <button id="btnToday">ì˜¤ëŠ˜</button>
          <button id="btnSave" class="ok">ì €ì¥</button>
          <button id="btnDelete" class="danger">ì´ ë‚ ì§œ ê¸°ë¡ ì‚­ì œ</button>
          <button id="btnOpenSettings">ì„¤ì •</button>
          <button id="btnLogout">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="flex: 1 1 480px;">
          <div class="muted">ìë™ ìš”ì•½ (1~2ì¤„)</div>
          <div id="summaryBox" class="summaryBox" style="margin-top:6px;">-</div>
          <div id="updatedAt" class="muted" style="margin-top:8px;"></div>
        </div>

        <div style="min-width:240px;">
          <div class="muted">ìµœê·¼ ê¸°ë¡ (í´ë¦­í•˜ë©´ ì´ë™)</div>
          <div id="recentList" style="margin-top:6px;"></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="muted">ë³¸ë¬¸</div>
      <textarea id="textArea" placeholder="ì´ ë‚ ì§œì˜ ê¸°ë¡ì„ ì‘ì„±í•˜ì‹­ì‹œì˜¤."></textarea>
      <div class="muted" style="margin-top:8px;">
        ì €ì¥ì„ ëˆ„ë¥´ë©´ ë‚ ì§œë³„ë¡œ ì €ì¥ë˜ë©°, ë‹¬ë ¥ì—ì„œ ê³¼ê±° ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ ìë™ìœ¼ë¡œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
      </div>
    </div>

  </div>

  <!-- SETTINGS MODAL (hidden by default) -->
  <div id="settingsOverlay" class="overlay hidden" role="dialog" aria-modal="true" aria-label="ì„¤ì •">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">ì„¤ì •</div>
          <div class="muted" style="margin-top:4px;">ID/PIN ë³€ê²½ ë° ë°±ì—…/ë³µì›ì€ ì´ í™”ë©´ì—ì„œ ê°€ëŠ¥í•©ë‹ˆë‹¤.</div>
        </div>
        <button id="btnCloseSettings" class="modalClose" title="ë‹«ê¸°" aria-label="ë‹«ê¸°">âœ•</button>
      </div>

      <div class="sep"></div>

      <!-- ID/PIN -->
      <div class="grid2">
        <div>
          <div class="muted">ìƒˆ ë¡œê·¸ì¸ ID</div>
          <input id="newId" type="text" placeholder="ìƒˆ ID" />
        </div>
        <div>
          <div class="muted">ìƒˆ PIN (4~8ìë¦¬ ìˆ«ì)</div>
          <input id="newPin" type="password" inputmode="numeric" pattern="[0-9]*" placeholder="ìƒˆ PIN" />
        </div>
      </div>

      <div class="row smallBtnRow" style="margin-top:12px;">
        <button id="btnChangeAuth" class="ok">ID/PIN ì €ì¥</button>
        <button id="btnCancelSettings">ë‹«ê¸°</button>
        <span class="muted">ë¡œì»¬ ì €ì¥(localStorage) ê¸°ë°˜ì…ë‹ˆë‹¤.</span>
      </div>

      <div id="settingsMsg" class="muted" style="margin-top:10px;"></div>

      <div class="sep"></div>

      <!-- BACKUP / RESTORE -->
      <div class="row" style="justify-content:space-between;">
        <div>
          <div style="font-weight:800;">ë°±ì—… / ë³µì›</div>
          <div class="muted" style="margin-top:4px;">ê¸°ë¡ì„ .json íŒŒì¼ë¡œ ì €ì¥í•˜ê³ , ë‚˜ì¤‘ì— ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>

      <div class="row smallBtnRow" style="margin-top:10px;">
        <button id="btnExport" class="ok">ğŸ“¦ ì „ì²´ ë°±ì—…(.json)</button>
        <button id="btnImportMerge">â™»ï¸ ë³µì›(í•©ì¹˜ê¸°)</button>
        <button id="btnImportReplace" class="danger">â™»ï¸ ë³µì›(ë®ì–´ì“°ê¸°)</button>
        <input id="importFile" type="file" accept="application/json,.json" class="hidden" />
      </div>

      <div class="warnBox">
        â€¢ â€œí•©ì¹˜ê¸°â€ëŠ” ê¸°ì¡´ ê¸°ë¡ì„ ìœ ì§€í•˜ë©´ì„œ ë°±ì—… íŒŒì¼ì˜ ê¸°ë¡ì„ ì¶”ê°€/ê°±ì‹ í•©ë‹ˆë‹¤(ê°™ì€ ë‚ ì§œëŠ” ìµœì‹  ê²ƒìœ¼ë¡œ ê°±ì‹ ).<br/>
        â€¢ â€œë®ì–´ì“°ê¸°â€ëŠ” í˜„ì¬ ê¸°ê¸° ì•ˆì˜ ê¸°ë¡ì„ ì§€ìš°ê³  ë°±ì—… íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ì „ì²´ êµì²´í•©ë‹ˆë‹¤.<br/>
        â€¢ ë°±ì—… íŒŒì¼ì—ëŠ” ê¸°ë¡ ë‚´ìš©ì´ ëª¨ë‘ í¬í•¨ë©ë‹ˆë‹¤. ë³´ê´€ ìœ„ì¹˜ë¥¼ ì‹ ì¤‘íˆ ì„ íƒí•˜ì‹­ì‹œì˜¤.
      </div>

      <div id="backupMsg" class="muted" style="margin-top:10px;"></div>
    </div>
  </div>

  <!-- FOOTER COPYRIGHT -->
  <div class="footer">
    Â© <span id="yearNow"></span> James Baek. All rights reserved.
  </div>

</div>

<script>
  // ===== Helpers =====
  const $ = (id) => document.getElementById(id);

  function setStatus(msg){
    $("status").textContent = msg;
    setTimeout(() => { $("status").textContent = "Ready"; }, 1200);
  }

  function pad2(n){ return String(n).padStart(2, "0"); }
  function todayISO(){
    const d = new Date();
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
  }
function formatLocalTime(iso){
  if (!iso) return "";
  const d = new Date(iso);
  return d.toLocaleString("ko-KR", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit"
  });
}
  // ===== Storage Keys (ê³ ì •) =====
  const AUTH_KEY = "idid:auth";        // {id,pin}
  const SESSION_KEY = "idid:session";  // {loggedIn:true}
  const ENTRY_PREFIX = "idid:diary:";  // idid:diary:YYYY-MM-DD

  function entryKey(dateISO){ return `${ENTRY_PREFIX}${dateISO}`; } // {date,text,summary,updatedAt}

  // ===== Default Auth =====
  function ensureDefaultAuth(){
    const raw = localStorage.getItem(AUTH_KEY);
    if (!raw){
      localStorage.setItem(AUTH_KEY, JSON.stringify({ id: "admin", pin: "1234" }));
      return;
    }
    // JSON ê¹¨ì§„ ê²½ìš°ì—ë§Œ ë³µêµ¬
    try { JSON.parse(raw); }
    catch { localStorage.setItem(AUTH_KEY, JSON.stringify({ id: "admin", pin: "1234" })); }
  }

  function getAuth(){
    try { return JSON.parse(localStorage.getItem(AUTH_KEY) || "{}"); }
    catch { return {}; }
  }

  function setSession(loggedIn){
    localStorage.setItem(SESSION_KEY, JSON.stringify({ loggedIn: !!loggedIn }));
  }

  function getSession(){
    try { return JSON.parse(localStorage.getItem(SESSION_KEY) || "{}"); }
    catch { return {}; }
  }

  // ===== Summary (local heuristic 1~2 lines) =====
  function summarizeText(text){
    const cleaned = (text || "")
      .replace(/\r/g, "")
      .replace(/[ \t]+/g, " ")
      .trim();

    if (!cleaned) return "";

    const sentences = cleaned
      .replace(/\n+/g, " ")
      .split(/(?<=[\.\!\?ã€‚]|ë‹¤\.|ìš”\.|í•¨\.|ì„\.)\s+|(?<=\.)\s+|(?<=\!)\s+|(?<=\?)\s+/g)
      .map(s => s.trim())
      .filter(s => s.length >= 6);

    let summary = "";
    if (sentences.length) summary = sentences.slice(0, 2).join(" ").trim();
    else summary = cleaned.split("\n").map(s => s.trim()).filter(Boolean).slice(0,2).join(" ").trim();

    const MAX = 160;
    if (summary.length > MAX) summary = summary.slice(0, MAX).trim() + "â€¦";
    return summary;
  }

  // ===== Entry CRUD =====
  function loadEntry(dateISO){
    const raw = localStorage.getItem(entryKey(dateISO));
    if (!raw) return null;
    try { return JSON.parse(raw); } catch { return null; }
  }

  function saveEntry(dateISO, text){
    const entry = {
      date: dateISO,
      text: text || "",
      summary: summarizeText(text),
      updatedAt: new Date().toISOString()
    };
    localStorage.setItem(entryKey(dateISO), JSON.stringify(entry));
    return entry;
  }

  function deleteEntry(dateISO){
    localStorage.removeItem(entryKey(dateISO));
  }

  // ===== Recent Entries List =====
  function listRecentEntries(limit=10){
    const items = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (!k || !k.startsWith(ENTRY_PREFIX)) continue;
      const raw = localStorage.getItem(k);
      try {
        const e = JSON.parse(raw);
        if (e && e.date) items.push(e);
      } catch {}
    }
    items.sort((a,b) => String(b.updatedAt || "").localeCompare(String(a.updatedAt || "")));
    return items.slice(0, limit);
  }

  function renderRecent(){
    const box = $("recentList");
    box.innerHTML = "";
    const list = listRecentEntries(10);

    if (!list.length){
      box.innerHTML = `<div class="muted">(ìµœê·¼ ê¸°ë¡ ì—†ìŒ)</div>`;
      return;
    }

    list.forEach(e => {
      const btn = document.createElement("button");
      btn.style.display = "block";
      btn.style.width = "100%";
      btn.style.marginBottom = "6px";
      btn.textContent = e.date;
      btn.addEventListener("click", () => {
        renderForDate(e.date);
        setStatus("ì´ë™");
      });
      box.appendChild(btn);
    });
  }

  // ===== Screen Control =====
  function showAuth(){
    $("authScreen").classList.remove("hidden");
    $("appScreen").classList.add("hidden");
  }

  function showApp(){
    $("authScreen").classList.add("hidden");
    $("appScreen").classList.remove("hidden");
  }

  // ===== App Rendering =====
  let selectedDate = todayISO();

  function renderForDate(dateISO){
    selectedDate = dateISO;
    $("datePicker").value = dateISO;
    $("selectedDateLabel").textContent = dateISO;

    const entry = loadEntry(dateISO);
    if (entry){
      $("textArea").value = entry.text || "";
      $("summaryBox").textContent = entry.summary ? entry.summary : "(ìš”ì•½ ì—†ìŒ)";
      $("updatedAt").textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${formatLocalTime(entry.updatedAt)}`;

    } else {
      $("textArea").value = "";
      $("summaryBox").textContent = "(ê¸°ë¡ ì—†ìŒ)";
      $("updatedAt").textContent = "";
    }
    renderRecent();
  }

  // ===== Auth =====
  function login(){
    const id = ($("idInput").value || "").trim();
    const pin = ($("pinInput").value || "").trim();
    const auth = getAuth();

    if (!id || !pin){
      $("authError").textContent = "IDì™€ PINì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤.";
      return;
    }
    if (id === auth.id && pin === auth.pin){
      $("authError").textContent = "";
      setSession(true);
      showApp();
      renderForDate(todayISO());
      setStatus("ë¡œê·¸ì¸ ì„±ê³µ");
    } else {
      $("authError").textContent = "ID ë˜ëŠ” PINì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
    }
  }

  function logout(){
    setSession(false);
    $("idInput").value = "";
    $("pinInput").value = "";
    showAuth();
    setStatus("ë¡œê·¸ì•„ì›ƒ");
  }

  // ===== Settings Modal =====
  function openSettings(){
    $("settingsMsg").textContent = "";
    $("backupMsg").textContent = "";
    $("settingsOverlay").classList.remove("hidden");
    setTimeout(() => { $("newId").focus(); }, 0);
  }

  function closeSettings(){
    $("settingsOverlay").classList.add("hidden");
  }

  function changeAuth(){
    const newId = ($("newId").value || "").trim();
    const newPin = ($("newPin").value || "").trim();

    if (!newId && !newPin){
      $("settingsMsg").textContent = "ë³€ê²½í•  ID ë˜ëŠ” PINì„ ì…ë ¥í•˜ì‹­ì‹œì˜¤.";
      return;
    }

    const current = getAuth();
    const updated = { ...current };

    if (newId) updated.id = newId;

    if (newPin){
      if (!/^\d{4,8}$/.test(newPin)){
        $("settingsMsg").textContent = "PINì€ 4~8ìë¦¬ ìˆ«ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
        return;
      }
      updated.pin = newPin;
    }

    localStorage.setItem(AUTH_KEY, JSON.stringify(updated));
    $("newId").value = "";
    $("newPin").value = "";
    $("settingsMsg").textContent = "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.";
    setStatus("ì„¤ì • ì €ì¥");
  }

  function setupOverlayClose(){
    $("settingsOverlay").addEventListener("click", (e) => {
      if (e.target === $("settingsOverlay")) closeSettings();
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !$("settingsOverlay").classList.contains("hidden")){
        closeSettings();
      }
    });
  }

  // ===== Backup / Restore =====
  function getAllDiaryEntries(){
    const entries = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (!k || !k.startsWith(ENTRY_PREFIX)) continue;
      const raw = localStorage.getItem(k);
      try {
        const e = JSON.parse(raw);
        if (e && e.date) entries.push(e);
      } catch {}
    }
    // ë‚ ì§œ ìˆœìœ¼ë¡œ ì •ë ¬(ì½ê¸° í¸í•˜ê²Œ)
    entries.sort((a,b) => String(a.date).localeCompare(String(b.date)));
    return entries;
  }

  function exportBackup(){
    try {
      const auth = getAuth();            // ID/PINë„ í¬í•¨(ì›í•˜ì‹œë©´ ì œì™¸ ê°€ëŠ¥)
      const entries = getAllDiaryEntries();

      const payload = {
        meta: {
          app: "IDID^^",
          version: 1,
          exportedAt: new Date().toISOString(),
          origin: location.origin
        },
        auth: auth,
        entries: entries
      };

      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);

      const filename = `IDID_backup_${todayISO()}.json`;
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      $("backupMsg").textContent = `ë°±ì—… ì™„ë£Œ: ${filename} (ê¸°ë¡ ${entries.length}ê°œ)`;
      setStatus("ë°±ì—… ì™„ë£Œ");
    } catch (err) {
      console.error(err);
      $("backupMsg").textContent = "ë°±ì—… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  function validateBackupObject(obj){
    if (!obj || typeof obj !== "object") return false;
    if (!obj.meta || obj.meta.app !== "IDID^^") return false;
    if (!Array.isArray(obj.entries)) return false;
    return true;
  }

  function clearAllDiaryEntries(){
    const toDelete = [];
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (k && k.startsWith(ENTRY_PREFIX)) toDelete.push(k);
    }
    toDelete.forEach(k => localStorage.removeItem(k));
  }

  // mode: "merge" | "replace"
  function applyBackup(obj, mode){
    if (!validateBackupObject(obj)) {
      $("backupMsg").textContent = "ì´ íŒŒì¼ì€ IDID^^ ë°±ì—… íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.";
      return;
    }

    if (mode === "replace") {
      clearAllDiaryEntries();
    }

    // auth ì ìš©(ì›í•˜ë©´ ì œì™¸ ê°€ëŠ¥)
    if (obj.auth && typeof obj.auth === "object") {
      // ìµœì†Œí•œì˜ í˜•íƒœë§Œ í—ˆìš©
      const id = String(obj.auth.id || "").trim();
      const pin = String(obj.auth.pin || "").trim();
      if (id && pin) {
        localStorage.setItem(AUTH_KEY, JSON.stringify({ id, pin }));
      }
    }

    // entries ì ìš©
    let imported = 0;
    let updated = 0;

    // ê¸°ì¡´ ì—”íŠ¸ë¦¬ ë§µ(ì—…ë°ì´íŠ¸ ì—¬ë¶€ íŒë‹¨ìš©)
    const existingMap = new Map();
    for (let i=0; i<localStorage.length; i++){
      const k = localStorage.key(i);
      if (!k || !k.startsWith(ENTRY_PREFIX)) continue;
      const date = k.slice(ENTRY_PREFIX.length);
      existingMap.set(date, localStorage.getItem(k));
    }

    for (const e of obj.entries){
      if (!e || typeof e !== "object") continue;
      const date = String(e.date || "").trim();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) continue;

      const normalized = {
        date,
        text: String(e.text || ""),
        summary: String(e.summary || summarizeText(String(e.text || ""))),
        updatedAt: String(e.updatedAt || new Date().toISOString())
      };

      const key = entryKey(date);
      const prev = existingMap.get(date);

      if (prev) updated++;
      else imported++;

      localStorage.setItem(key, JSON.stringify(normalized));
    }

    $("backupMsg").textContent =
      (mode === "replace")
        ? `ë³µì›(ë®ì–´ì“°ê¸°) ì™„ë£Œ: ì¶”ê°€ ${imported}ê°œ / ê°±ì‹  ${updated}ê°œ`
        : `ë³µì›(í•©ì¹˜ê¸°) ì™„ë£Œ: ì¶”ê°€ ${imported}ê°œ / ê°±ì‹  ${updated}ê°œ`;

    setStatus("ë³µì› ì™„ë£Œ");

    // í™”ë©´ ì¦‰ì‹œ ë°˜ì˜
    renderForDate(selectedDate);
  }

  let importMode = "merge";
  function triggerImport(mode){
    importMode = mode;
    $("importFile").value = ""; // ê°™ì€ íŒŒì¼ ì¬ì„ íƒ ê°€ëŠ¥í•˜ê²Œ
    $("importFile").click();
  }

  function handleImportFile(file){
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const text = String(reader.result || "");
        const obj = JSON.parse(text);
        applyBackup(obj, importMode);
      } catch (err) {
        console.error(err);
        $("backupMsg").textContent = "íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (JSON í˜•ì‹ ì˜¤ë¥˜)";
      }
    };
    reader.onerror = () => {
      $("backupMsg").textContent = "íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    };
    reader.readAsText(file, "utf-8");
  }

  // ===== Events =====
  $("btnLogin").addEventListener("click", login);
  $("pinInput").addEventListener("keydown", (e) => { if (e.key === "Enter") login(); });
  $("idInput").addEventListener("keydown", (e) => { if (e.key === "Enter") $("pinInput").focus(); });

  $("btnLogout").addEventListener("click", logout);

  $("datePicker").addEventListener("change", (e) => {
    if (e.target.value) renderForDate(e.target.value);
  });

  $("btnToday").addEventListener("click", () => renderForDate(todayISO()));

  $("btnSave").addEventListener("click", () => {
    const entry = saveEntry(selectedDate, $("textArea").value);
    $("summaryBox").textContent = entry.summary ? entry.summary : "(ìš”ì•½ ì—†ìŒ)";
    $("updatedAt").textContent = `ë§ˆì§€ë§‰ ì €ì¥: ${formatLocalTime(entry.updatedAt)}`;
    renderRecent();
    setStatus("ì €ì¥ ì™„ë£Œ");
  });

  $("btnDelete").addEventListener("click", () => {
    deleteEntry(selectedDate);
    renderForDate(selectedDate);
    setStatus("ì‚­ì œ ì™„ë£Œ");
  });

  $("btnOpenSettings").addEventListener("click", openSettings);
  $("btnCloseSettings").addEventListener("click", closeSettings);
  $("btnCancelSettings").addEventListener("click", closeSettings);
  $("btnChangeAuth").addEventListener("click", changeAuth);

  // Backup/Restore buttons
  $("btnExport").addEventListener("click", exportBackup);
  $("btnImportMerge").addEventListener("click", () => triggerImport("merge"));
  $("btnImportReplace").addEventListener("click", () => triggerImport("replace"));
  $("importFile").addEventListener("change", (e) => handleImportFile(e.target.files && e.target.files[0]));

  // ===== Boot =====
  (function boot(){
    $("yearNow").textContent = String(new Date().getFullYear());
    ensureDefaultAuth();
    setupOverlayClose();

    const session = getSession();
    if (session.loggedIn){
      showApp();
      renderForDate(todayISO());
    } else {
      showAuth();
    }
  })();
</script>
</body>
</html>
